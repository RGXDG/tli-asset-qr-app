<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset QR Gen v4</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Asset QR">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/241/241528.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { text-align: center; color: #1e293b; margin-top: 0; }
        label { font-size: 0.8rem; color: #64748b; font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin: 5px 0 12px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; background: #fff; font-size: 14px; }
        .specs-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        button { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-gen { background: #2563eb; color: white; }
        .btn-save { background: #10b981; color: white; }
        .btn-share { background: #8b5cf6; color: white; } /* Purple for Share */
        .btn-clear { background: #94a3b8; color: white; }
        .btn-test { background: #f59e0b; color: white; border: 2px dashed #b45309; }
        
        #canvas { margin-top: 20px; display: flex; justify-content: center; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Asset Tag Generator</h2>
    
    <button class="btn-test" onclick="randomizeData()">DEBUG: Randomize Data</button>
    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
    
    <label>Manufacturer</label>
    <select id="make">
        <option value="">Select Make...</option>
        <option value="Dell">Dell</option>
        <option value="Lenovo">Lenovo</option>
        <option value="HP">HP</option>
        <option value="Apple">Apple</option>
        <option value="Not Specified">Not Specified</option>
    </select>

    <label>Model & OS</label>
    <input type="text" id="model" placeholder="Model">
    <input type="text" id="os" placeholder="OS">
    
    <label>Serial Number</label>
    <input type="text" id="sn" placeholder="Serial Number">

    <label>Specifications</label>
    <div class="specs-grid">
        <select id="spec_cpu"><option value="">CPU</option><option value="i5">i5</option><option value="i7">i7</option><option value="Mac">Mac</option><option value="Ryzen">Ryzen</option></select>
        <select id="spec_disk"><option value="">Disk</option><option value="256GB">256GB</option><option value="512GB">512GB</option><option value="1TB">1TB</option></select>
        <select id="spec_ram"><option value="">RAM</option><option value="8GB">8GB</option><option value="16GB">16GB</option><option value="32GB">32GB</option></select>
    </div>

    <label>Condition</label>
    <select id="condition">
        <option value="">Select Condition...</option>
        <option value="Fair">Fair</option>
        <option value="Good">Good</option>
        <option value="Excellent">Excellent</option>
    </select>

    <label>Volunteer</label>
    <input type="text" id="volunteer" placeholder="Your Name">
    
    <button class="btn-gen" onclick="generateQR()">Generate QR Code</button>
    <button class="btn-clear" onclick="clearForm()">Clear Form</button>
    
    <div id="canvas"></div>
    
    <div id="controls" style="display:none; text-align: center;">
        <div class="btn-group">
            <button class="btn-save" onclick="handleAction('download', 'png')">Save PNG</button>
            <button class="btn-share" onclick="handleAction('share', 'png')">Share PNG</button>
        </div>
        <div class="btn-group">
            <button class="btn-save" onclick="handleAction('download', 'pdf')">Save PDF</button>
            <button class="btn-share" onclick="handleAction('share', 'pdf')">Share PDF</button>
        </div>
    </div>
</div>

<script>
    let qrCode;

    function randomizeData() {
        document.getElementById('make').value = "Dell";
        document.getElementById('model').value = "Latitude";
        document.getElementById('os').value = "Win 11";
        document.getElementById('sn').value = "SN-" + Math.random().toString(36).substring(7).toUpperCase();
        document.getElementById('spec_cpu').value = "i7";
        document.getElementById('spec_disk').value = "512GB";
        document.getElementById('spec_ram').value = "16GB";
        document.getElementById('condition').value = "Excellent";
        document.getElementById('volunteer').value = "Admin";
    }

    function clearForm() {
        const ids = ['make', 'model', 'os', 'sn', 'spec_cpu', 'spec_disk', 'spec_ram', 'condition', 'volunteer'];
        ids.forEach(id => document.getElementById(id).value = "");
        document.getElementById("canvas").innerHTML = "";
        document.getElementById("controls").style.display = "none";
    }

    function generateQR() {
        const fields = {
            sn: document.getElementById('sn').value.trim(),
            make: document.getElementById('make').value
        };
        if (!fields.sn || !fields.make) { alert("Please fill details first."); return; }
        
        const dataString = `SN:${fields.sn}||MAKE:${fields.make}`;

        qrCode = new QRCodeStyling({
            width: 300, height: 300, data: dataString,
            dotsOptions: { color: "#1e293b", type: "rounded" },
            backgroundOptions: { color: "#fff" }
        });

        const canvasDiv = document.getElementById("canvas");
        canvasDiv.innerHTML = ""; 
        qrCode.append(canvasDiv);
        document.getElementById("controls").style.display = "block";
    }

    async function handleAction(mode, format) {
        if (!qrCode) return;
        const fileName = `Asset-${document.getElementById('sn').value}`;
        
        // 1. Get raw image data from the QR styler
        const rawBlob = await qrCode.getRawData("png");
        
        if (format === 'png') {
            if (mode === 'download') {
                qrCode.download({ name: fileName, extension: "png" });
            } else {
                const file = new File([rawBlob], `${fileName}.png`, { type: "image/png" });
                shareFile(file);
            }
        } else if (format === 'pdf') {
            // Generate PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imgData = e.target.result;
                const pdf = new jsPDF();
                pdf.addImage(imgData, 'PNG', 40, 40, 130, 130);
                pdf.text(`Asset: ${fileName}`, 105, 180, { align: 'center' });
                
                const pdfBlob = pdf.output('blob');
                
                if (mode === 'download') {
                    // Direct Download Logic
                    const blobUrl = URL.createObjectURL(pdfBlob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = `${fileName}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
                } else {
                    // Share Logic
                    const file = new File([pdfBlob], `${fileName}.pdf`, { type: "application/pdf" });
                    shareFile(file);
                }
            };
            reader.readAsDataURL(rawBlob);
        }
    }

    async function shareFile(file) {
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({ files: [file], title: 'Asset Tag' });
            } catch (err) {
                console.log("Share failed", err);
            }
        } else {
            alert("Sharing not supported on this browser/device.");
        }
    }
</script>
</body>
</html>
